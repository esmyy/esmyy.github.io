## 静态与动态

静态作用域和动态作用域是两种不同的变量查找规则，是语言级别的划分，而不是程序范围的划分。

### 静态作用域

也叫 **词法作用域**，这也是 JavaScript 使用的，静态作用域关注在 何处声明，查找的时候，由声明的位置开始去查找标识符

```js
var value = 12;
function foo() {
  console.log(value);
}

function bar() {
  var value = 24;
  foo(); // 12
}

bar();
```

在 bar 定义了 `var value = 24` 然后调用了 foo，但是在 foo 中输出的仍是外部的 value。对于 value 的查找，是根据其声明的位置去查找的，在 foo 中未查找到，则向 foo 所在的父级作用域查找。

### 动态作用域

bash 使用的是动态作用域，动态作用域关注的是在何处调用

```shell
#!/bin/bash

value=12;
foo(){
  echo "$value";
}

bar() {
  value=24;
}

foo # 12
bar # 24
foo # 24
```

如果在 foo 函数中未找到 value 标识符，则向 foo 函数调用的执行环境中查找。所以第 2 次输出是 24。

这和静态作用域的标识符查找过程形成了鲜明对比，但是并不准确。看这个 bash 的例子

动态函数关注的是在何处调用，这是没有错的，前提是要知道，在 bar 中是修改了外部定义的 value 而不是定义了局部的 value。

对于动态作用域，可以理解为它只有一个全局的变量环境，声明的所有标识符都存在一个对象上。不管在哪里修改 value，都是改的同一个变量，它没有局部作用域的概念。在静态作用域中，在函数中 var value = 24 是声明一个局部的变量，而在动态作用域中，value=24 只是一个重新赋值而已。

## 闭包的描述

关于闭包，有很多比较典型的描述

| 来源                        | 描述                                                                                     |
| --------------------------- | ---------------------------------------------------------------------------------------- |
| 《你不知道的 JS》           | 当函数可以记住并访问所在的词法作用域时，就产生了闭包，即使函数是在当前词法作用域之外执行 |
| 《JavaScript 高级程序设计》 | 闭包指的是那些引用了另一个函数作用域中变量的函数，通常是在嵌套函数中实现的               |
| 另一种很普遍的描述          | 闭包指的是那些引用了另一个函数作用域中变量的函数，通常是在嵌套函数中实现的               |

这些描述都很正确，但我却总觉得差点意思，有些蹊跷。这些解释可以归纳为

- 怎样怎样....产生了闭包
- 闭包....是函数，是函数，函数，数...

第 1 点，很明显只是在描述闭包的“形”，只是在想方设法告诉你，闭包长什么样子。第 2 点，把闭包说成是某些条件下的函数，对于理解并没有太大的帮助。

闭包，作用域，执行上下文 3 者的关系，真的不容易理解清楚。

| 来源                        | 描述                                                                                     |
| --------------------------- | ---------------------------------------------------------------------------------------- |
| 《你不知道的 JS》           | 当函数可以记住并访问所在的词法作用域时，就产生了闭包，即使函数是在当前词法作用域之外执行 |
| 《JavaScript 高级程序设计》 | 闭包指的是那些引用了另一个函数作用域中变量的函数，通常是在嵌套函数中实现的               |
| 另一种很普遍的描述          | 闭包指的是那些引用了另一个函数作用域中变量的函数，通常是在嵌套函数中实现的               |

我觉得还是 [MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures#lexical_scoping) 的解释最好

> A closure is the combination of a function bundled together (enclosed) with references to its surrounding state (the lexical environment). In other words, a closure gives you access to an outer function's scope from an inner function. In JavaScript, closures are created every time a function is created, at function creation time.

拆分关键点如下

- 闭包是绑定在一起(封闭)的函数及其周围状态(词汇环境)的引用的组合
- 闭包可以从内部函数访问外部函数的作用域
- 闭包是在每次创建函数时创建的

初看这个解释理解起来还不是那么直观，但随着理解的深入，深以为然。

<!-- 个人觉得闭包没有那么复杂，本质就是上级作用域内变量的生命周期，因为被下级作用域内引用，而没有被释放。就导致上级作用域内的变量，等到下级作用域执行完以后才正常得到释放。（个人理解，若有错误，欢迎指正） -->
