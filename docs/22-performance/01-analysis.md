# 性能优化

首先需要了解性能优化的背景，为什么需要优化，然后如何去优化，如何去评估优化效果。

## Why

页面的显示和交互等过程，让用户感受到不爽了，从而影响到了用户的留存转化，影响到商业目标等的达成。

是什么因素让用户觉得不爽？

思考并解决这个问题，有了 [Why does speed matter?](https://web.dev/why-speed-matters/)这方面对于网站的表现对用户体验的影响的研究，有了 [RAIL](https://web.dev/rail/)这样的评估方案。

性能优化，就是基于分析出的原因，探索解决方案，研究怎样通过技术手段，使得页面的表现更加满足用户的预期，改善用户体验。

## 性能分析

性能分析工具能够直观地给出性能优化的建议，性能优化时，应当参考着分析结果进行选择性优化。

性能分析的工具，在 [How To Think About Speed Tools](https://developers.google.com/web/fundamentals/performance/speed-tools?hl=zh_cn)进行了较为全面的介绍。 最基础的是 Chrome 自带的 Performance 和 Lighthouse，在 Chrome 的开发者工具中，Lighthouse 或者 Audits 标签下可以看到 Lighthouse。

性能优化是系统性工程，在具体优化时，应当结合具体分析结果，有重点地，渐进地优化，避免不切实际的全面优化或者说从头优化。不过在认知形成和基础知识掌握上，我们确实可以做较为系统的梳理，了解可能的优化点，以作参考。

## 使用缓存

客户端的缓存，CDN 的缓存等

### 本地缓存使用

- LocalStorage(ls) 缓存：可使用 ls 缓存长期不会改变的静态资源，比如 百度 (opens new window)就缓存了
- Cookie: Cookie 就是谨慎使用，注意 Cookie 的大小，毕竟请求会带上 Cookie，数据量不小的

### 缓存策略选择

既要保证有效更新，又要保证充分利用。根据不同的更新频繁程度，选择合适的缓存策略，对于有效利用缓存至关重要。

如今的主流方案，基本上都是基本上都是 html 文件在源站服务器，其他静态资源在 CDN。在源站服务器，就适合设置协商缓存，比如

```bash
Cache-Control: no-cache
```

而 CDN 上的静态资源，就应当设置较长的有效期。

关于 HTTP 缓存可参考 HTTP 缓存。

## 各类文件优化

文件的优化，主要是从两方面切入

- 减少文件大小
- 减少请求次数

具体来说可以有以下优化方式

- js 等文件的提取和拆分
- 各类文件压缩
- 使用 TreeShaking 等方式去掉未使用代码
- CSR，Prerender 和 SSR 方案的合理选择

可参考 图片优化 和 CSS 优化

## 渲染流程优化

预加载，懒加载
合理组织代码相对位置,减少阻塞
减少重绘和回流
CDN 多域名，提升并行加载数
defer, async，异步加载，延迟执行
关注关键路径渲染
可参考 渲染流程

## 其他

使用 HTTP/2.0
dns prefetch
