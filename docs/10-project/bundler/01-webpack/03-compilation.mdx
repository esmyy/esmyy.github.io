# compilation

compilation è´Ÿè´£ä¸€æ¬¡å…·ä½“ç¼–è¯‘è¿‡ç¨‹ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ Compilation å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œåšäº†äº›ä»€ä¹ˆ

```js
class Compilation {
  constructor(compiler) {
    const getNormalModuleLoader = () => deprecatedNormalModuleLoaderHook(this);
    this.hooks = Object.freeze({
      buildModule: new SyncHook(["module"]),
      rebuildModule: new SyncHook(["module"]),
      failedModule: new SyncHook(["module", "error"]),
      succeedModule: new SyncHook(["module"]),
      stillValidModule: new SyncHook(["module"]),
      addEntry: new SyncHook(["entry", "name"]),
      failedEntry: new SyncHook(["entry", "name", "error"]),
      succeedEntry: new SyncHook(["entry", "name", "module"]),
      // ...ä¸€å †äº‹ä»¶å®šä¹‰
    });

    this.factorizeQueue = new AsyncQueue({
      name: "factorize",
      parallelism: options.parallelism || 100,
      processor: this._factorizeModule.bind(this),
    });

    this.name = undefined;
    this.compiler = compiler;
    const options = compiler.options;
    this.options = options;
    this.profile = (options && options.profile) || false;
    // ...ä¸€å †å±æ€§å®šä¹‰
  }
}
```

compilation åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œä¸ compiler ç±»ä¼¼ï¼Œä¸åŒçš„åœ¨äºï¼Œcompilation çš„äº‹ä»¶æ˜¯ module çº§åˆ«çš„ï¼Œé’ˆå¯¹äºæ¨¡å—ç¼–è¯‘è¿‡ç¨‹ä¸­çš„äº‹ä»¶ï¼Œè€Œ compiler çš„æ˜¯ process çº§åˆ«çš„ã€‚

## ç¼–è¯‘å…¥å£

åœ¨ compiler åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè°ƒç”¨äº† compiler.compile æ‰§è¡Œç¼–è¯‘

```js title="lib/Compiler.js"
compile(callback) {
  this.hooks.beforeCompile.callAsync(params, err => {
    const compilation = this.newCompilation(params);

    // ...
    this.hooks.make.callAsync(compilation, err => {
      // ...
    });
  });
}
```

`hooks.make.tap`æ˜¯ä¸€æ¬¡ç¼–è¯‘çš„å‘ä»¤æªï¼Œå…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹åœ¨äº‹ä»¶çš„è®¢é˜…å‡½æ•°å½“ä¸­ï¼Œå¯é€šè¿‡æœç´¢ `hooks.make.tap` æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°

```js
grep -rn hooks.make.tap ./lib
```

å¾—åˆ°

```js
./lib/AutomaticPrefetchPlugin.js:  compiler.hooks.make.tapAsync(
./lib/PrefetchPlugin.js:  compiler.hooks.make.tapAsync("PrefetchPlugin", (compilation, callback) => {
./lib/EntryPlugin.js:  compiler.hooks.make.tapAsync("EntryPlugin", (compilation, callback) => {
./lib/DynamicEntryPlugin.js:  compiler.hooks.make.tapAsync(
./lib/DllEntryPlugin.js:  compiler.hooks.make.tapAsync("DllEntryPlugin", (compilation, callback) => {
```

make å…·ä½“åšçš„äº‹æƒ…å°±åœ¨è¿™å‡ ä¸ªå›è°ƒå‡½æ•°é‡Œé¢ã€‚ä»åå­—å¯ä»¥åŒºåˆ†å¤§æ¦‚æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œè¿™é‡Œä» EntryPlugin.js å¼€å§‹ç ”ç©¶ï¼Œè¿™ä¸ªæ’ä»¶æ˜¯ç”¨æ¥å¤„ç†é…ç½®çš„ entryï¼Œç¼–è¯‘è‡ªç„¶æ˜¯ä»å…¥å£å¼€å§‹å¤„ç†

```js title="lib/EntryPlugin.js"
const EntryDependency = require("./dependencies/EntryDependency");

class EntryPlugin {
  constructor(context, entry, name) {
    this.context = context;
    this.entry = entry;
    this.name = name;
  }

  apply(compiler) {
    // ...

    compiler.hooks.make.tapAsync("EntryPlugin", (compilation, callback) => {
      const { entry, name, context } = this;
      const dep = EntryPlugin.createDependency(entry, name);
      compilation.addEntry(context, dep, name, (err) => {
        callback(err);
      });
    });
  }

  static createDependency(entry, name) {
    const dep = new EntryDependency(entry);
    dep.loc = { name };
    return dep;
  }
}
```

è¿™é‡Œçš„ entry å·²ç»æ˜¯å•ä¸ªå…¥å£æ–‡ä»¶ï¼Œæ˜¯åœ¨ compiler åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„`WebpackOptionsApply`é‡Œé¢å¤„ç†è¿‡çš„ã€‚æµç¨‹éå¸¸é•¿ï¼Œä¹Ÿå¾ˆç»•ï¼Œä¼šæ³¨å†Œå¾ˆå¤šå¾ˆå¤šçš„é’©å­ï¼Œäº‹ä»¶ä¹‹é—´è§¦å‘çš„é¡ºåºé€»è¾‘å¹¶ä¸é‚£ä¹ˆä¸€ç›®äº†ç„¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ NormalModule çš„ build æ–¹æ³•ï¼Œè¿›è¡Œæ¨¡å—çš„ç¼–è¯‘ã€‚

:::info ğŸ¤”
äº†è§£ compilation è¿‡ç¨‹ï¼Œä¸»è¦æƒ³å…³æ³¨çš„æ˜¯å¦‚ä½•è¯»å–æ–‡ä»¶ç¼–è¯‘æ–‡ä»¶ï¼ŒaddEntry ä¹‹åçš„è°ƒç”¨é“¾éå¸¸çš„é•¿ï¼Œä¼šç»•å¾ˆé•¿çš„è·¯ï¼Œè€Œä¸”å¹¶ä¸æ˜¯ç‰¹åˆ«å…³æ³¨çš„ä¸»æµç¨‹ï¼Œä¸è¦å»å…³æ³¨å®ƒçš„å…·ä½“æµç¨‹ï¼ŒæŠŠæ¡ä¸»è¦æµç¨‹å³å¯ã€‚
:::

## ç¼–è¯‘è¿‡ç¨‹

ç¼–è¯‘è¿‡ç¨‹çš„å®ç°åœ¨ NormalModule é‡Œé¢ï¼Œä¼šå…ˆè°ƒç”¨ build å‡½æ•°ï¼Œå†è°ƒç”¨ doBuild å‡½æ•°

```js
const { getContext, runLoaders } = require("loader-runner");

class NormalModule extends Module {
  build(options, compilation, resolver, fs, callback) {
    return this.doBuild(options, compilation, resolver, fs, (err) => {
      const handleParseResult = (result) => {
        // ...
        return callback();
      };

      // ...
      handleParseResult(result);
    });
  }

  // ...
  doBuild(options, compilation, resolver, fs, callback) {
    const processResult = (err, result) => {
      // ...
      return callback();
    };

    // ...
    runLoaders(
      {
        resource: this.resource,
        loaders: this.loaders,
        context: loaderContext,
        readResource: fs.readFile.bind(fs),
      },
      (err, result) => {
        // ...
        processResult(err || err2, result.result);
      }
    );
  }
}
```

doBuild é‡Œé¢æ˜¯è°ƒç”¨ runLoaders æ‰§è¡Œ loadersï¼Œloaders æ‰§è¡Œä¹‹åæ˜¯è°ƒç”¨å›è°ƒï¼Œæ¯ä¸€æ­¥æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¾æ¬¡è°ƒç”¨å¤–éƒ¨ä¼ å…¥çš„å›è°ƒã€‚
æ ¹æ®è°ƒç”¨é¡ºåºï¼Œå…ˆçœ‹ runLoaders çš„æ‰§è¡Œæƒ…å†µï¼Œéœ€è¦çš„æ—¶å€™å†å…³æ³¨å›è°ƒä¸­çš„ç»§ç»­æ‰§è¡Œè¿‡ç¨‹ã€‚

### runLoaders

è°ƒç”¨äº† runLoaders å»è¿è¡Œ loader å¯¹æ–‡ä»¶è¿›è¡Œå…·ä½“è½¬æ¢ã€‚çœç•¥ä¸­é—´çš„è¿‡ç¨‹ï¼Œç›´æ¥çœ‹ runLoaders çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè¾“å‡ºåˆæ˜¯ä»€ä¹ˆã€‚å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªä¾‹å­

<Tabs>
  <TabItem value="webpack.config.js" label="webpack.config.js" default>

```js
module.exports = {
  target: "web",
  mode: "production",
  entry: {
    app: "./app.js",
  },
  output: {
    filename: "[name][hash].js",
    path: path.resolve(__dirname, "dist"),
    publicPath: "",
  },
  module: {
    rules: [
      {
        test: /\.js$/i,
        use: {
          loader: "babel-loader",
          options: {
            presets: ["@babel/preset-env"],
          },
        },
      },
      {
        test: /\.css$/i,
        loader: "css-loader",
      },
    ],
  },
};
```

</TabItem>
<TabItem value="app.js" label="app.js">

```js
import "./style.css";
console.log("Hello World!!!");
```

  </TabItem>
  <TabItem value="style.css" label="style.css">

```css
.hello {
  color: red;
}
```

  </TabItem>
</Tabs>

åˆ™ `runLoaders` çš„å‚æ•°ç¤ºä¾‹å¦‚ä¸‹

<Tabs>
  <TabItem value="app.js" label="app.js" default>

```js
source: "/Users/esmyy/webpack-demo/app.js";
loaders: [
  {
    loader: "/Users/fengpeng/node_modules/babel-loader/lib/index.js",
    options: { presets: [Array] },
    ident: "ruleSet[1].rules[0].use",
  },
];
```

</TabItem>
  <TabItem value="style.css" label="style.css">

```css
source: "/Users/esmyy/webpack-demo/style.css";
loaders: [
  {
    loader: "/Users/fengpeng/node_modules/css-loader/dist/cjs.js",
    options: undefined,
    ident: undefined,
  },
];
```

</TabItem>
</Tabs>

æ³¨æ„åˆ° `runLoaders`å‚æ•°ä¸­ä¼ è¾“äº†å®Œæˆçš„æ¨¡å—è·¯å¾„ï¼Œä¼ å…¥äº† readFile å‡½æ•°ç”¨ä»¥è¯»å–æ¨¡å—æºå†…å®¹ã€‚å¯¹æ¯ä¸ªæ¨¡å—ï¼ŒrunLoaders ä¼šè¯»å–æºæ–‡ä»¶ï¼Œä½¿ç”¨ rules æ‰€åŒ¹é…çš„ loaders å»è½¬æ¢ã€‚runLoaders æ˜¯çœŸæ­£å¼€å§‹è¯»å–æºæ–‡ä»¶çš„èµ·ç‚¹ï¼Œä½†æ˜¯ loader ç›¸å…³çš„è¿‡ç¨‹æš‚æ—¶ä¸å»æ·±å…¥ï¼Œloader éœ€è¦å•ç‹¬çš„ç« èŠ‚å»æ¢³ç†ã€‚ç›®å‰æŠŠæ¡ä¸»æµç¨‹æ—¶ç›´æ¥çœ‹ä¸€ä¸‹ runLoaders è¿”å›çš„ç»“æœå³å¯

<Tabs>
  <TabItem value="app.js" label="app.js" default>

```js
// app.js
["import './style.css';\nconsole.log('Hello World!!!');", null];
```

</TabItem>
<TabItem value="style.css" label="style.css" default>

```js
[
  "// Imports\n" +
    'var ___CSS_LOADER_API_IMPORT___ = require("../../../../node_modules/css-loader/dist/runtime/api.js");\n' +
    "exports = ___CSS_LOADER_API_IMPORT___(false);\n" +
    "// Module\n" +
    'exports.push([module.id, ".hello {\\n  color: red;\\n}\\n", ""]);\n' +
    "// Exports\n" +
    "module.exports = exports;\n",
];
```

</TabItem>
</Tabs>

æ˜¾ç„¶ä» app.js è¿›è¿‡ babel-loader çš„å¤„ç†ç»“æœçœ‹ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰å¾—åˆ°æœ€ç»ˆç¼–è¯‘çš„ç»“æœï¼Œåªæ˜¯åšäº†ä¸€éƒ¨åˆ†è½¬æ¢ã€‚è¿˜éœ€è¦è¿›ä¸€æ­¥çœ‹è¿™ä¸ªè¿”å›å¦‚ä½•ä½¿ç”¨ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ `processResult`çš„å¤„ç†

```js title="doBuild é‡Œé¢çš„ processResult"
const processResult = (err, result) => {
  // ...ç•¥

  // result å®Œæ•´çš„æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªæ•°ç»„ [source, sourceMap, extraInfo]
  const source = result[0];
  const sourceMap = result.length >= 1 ? result[1] : null;
  const extraInfo = result.length >= 2 ? result[2] : null;

  // è½¬æ¢ä¸ºç»Ÿä¸€çš„sourceè¡¨ç¤ºç»“æœ
  this._source = this.createSource(
    options.context,
    this.binary ? asBuffer(source) : asString(source),
    sourceMap,
    compilation.compiler.root
  );

  // ...ç•¥

  // loader ä¸­æ˜¯å¦å·²ç»è½¬æ¢ä¸º ast äº†ï¼Œå¦‚æœloaderä¸­å·²ç»è¿”å›astï¼Œåˆ™ç›´æ¥å¤ç”¨ï¼Œåé¢å°±ä¸ç”¨é‡å¤ç”Ÿæˆäº†ï¼Œåœ¨æœ¬ä¾‹å­ä¸­éƒ½æ˜¯ null
  this._ast =
    typeof extraInfo === "object" &&
    extraInfo !== null &&
    extraInfo.webpackAST !== undefined
      ? extraInfo.webpackAST
      : null;
  return callback();
};
```

runLoaders çš„ç»“æœå®Œæ•´çš„æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªæ•°ç»„ `[source, sourceMap, extraInfo]`ï¼Œåœ¨æœ¬ä¾‹å­ä¸­ sourceMap å’Œ extraInfo éƒ½ä¸æ˜¯æœ‰æ•ˆå€¼ï¼Œæš‚æ—¶ä¹Ÿä¸ç”¨å…³æ³¨ã€‚`_ast`çš„è®¾ç½®æ˜¯ä¸ºäº†é¿å…é‡å¤ç”Ÿæˆ ASTï¼Œè¿™æ˜¯ loader ç›¸å…³çš„å†…å®¹ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯ nullã€‚æœ€åçœ‹ä¸€ä¸‹ \_source çš„ç»“æœï¼Œå…¶å®å°±æ˜¯æŠŠæ¨¡å—è½¬æ¢ä¸ºç»Ÿä¸€çš„ç»“æœï¼Œæ”¯æŒ String å’Œ Buffer ä¸¤ç§æ ¼å¼

<Tabs>
  <TabItem value="app.js" label="app.js" default>

```js
{
  _valueIsBuffer: false,
  _value: "import './style.css';\nconsole.log('Hello World!!!');",
  _valueAsBuffer: undefined,
  _valueAsString: "import './style.css';\nconsole.log('Hello World!!!');"
}
```

</TabItem>
  <TabItem value="styles.css" label="styles.css" default>

```js
{
  _valueIsBuffer: false,
  _value: '// Imports\n' +
    'var ___CSS_LOADER_API_IMPORT___ = require("../../../../node_modules/css-loader/dist/runtime/api.js");\n' +
    'exports = ___CSS_LOADER_API_IMPORT___(false);\n' +
    '// Module\n' +
    'exports.push([module.id, ".hello {\\n  color: red;\\n}\\n", ""]);\n' +
    '// Exports\n' +
    'module.exports = exports;\n',
  _valueAsBuffer: undefined,
  _valueAsString: '// Imports\n' +
    'var ___CSS_LOADER_API_IMPORT___ = require("../../../../node_modules/css-loader/dist/runtime/api.js");\n' +
    'exports = ___CSS_LOADER_API_IMPORT___(false);\n' +
    '// Module\n' +
    'exports.push([module.id, ".hello {\\n  color: red;\\n}\\n", ""]);\n' +
    '// Exports\n' +
    'module.exports = exports;\n'
}
```

</TabItem>
</Tabs>

æ€»ç»“ä¸€ä¸‹ï¼Œæ¨¡å—åŒ¹é…çš„ loader æ‰§è¡Œå®Œä¹‹åï¼Œå¯èƒ½åŒ…å«å·²ç»è½¬æ¢å¥½çš„ä¸€ä¸ª ASTï¼Œå¯¹äºæ–‡ä»¶ä¸­çš„ import å…³é”®å­—ï¼Œå¹¶æ²¡æœ‰è¢«æ›¿æ¢æ‰ï¼Œè¿™åœ¨åé¢è‚¯å®šæ˜¯éœ€è¦è¢«æ›¿æ¢çš„ã€‚

:::caution
éœ€è¦ä¸€ä¸ªæ€»ç»“ï¼ŒrunLoaders ç©¶ç«Ÿæ˜¯è¾¾åˆ°ä»€ä¹ˆæ•ˆæœï¼Œè¾“å‡ºä¸ºä»€ä¹ˆæ˜¯è¿™æ ·

<!-- TODO: å…¶å®è¿™é‡Œä¹Ÿæœ‰ä¾èµ–æ”¶é›†ï¼Œä¸ç„¶æ€ä¹ˆå¯èƒ½è·å¾—style.cssæ–‡ä»¶ -->

:::

### parse

runLoaders æ‰§è¡Œå®Œæˆä¹‹åï¼Œè°ƒç”¨äº†ä¼ å…¥çš„ callbackï¼Œä¸‹ä¸€æ­¥å¯ä»¥çœ‹çœ‹å¤–å±‚çš„å±‚å±‚å›è°ƒå„åšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯åç»­çš„å¤„ç†æ˜¯ä»€ä¹ˆã€‚
å›å¤´çœ‹ä¸€ä¸‹ `doBuild`çš„å›è°ƒ

```js
doBuild(options, compilation, resolver, fs, (err) => {
  // ...ç•¥

  const handleParseResult = (result) => {
    this.dependencies.sort(
      concatComparators(
        compareSelect((a) => a.loc, compareLocations),
        keepOriginalOrder(this.dependencies)
      )
    );
    this._lastSuccessfulBuildMeta = this.buildMeta;
    this._initBuildHash(compilation);
    return callback();
  };

  let result = this.parser.parse(this._ast || this._source.source(), {
    current: this,
    module: this,
    compilation: compilation,
    options: options,
  });

  handleParseResult(result);
});
```

åœ¨ 4.x ç‰ˆæœ¬ï¼Œparser å®šä¹‰åœ¨ [lib/Parser.js](https://github.com/webpack/webpack/blob/v4.46.0/lib/Parser.js)ï¼Œåœ¨ 5.x ä¹‹åæŒªåˆ°äº†
`lib/JavascriptParser.js` ä¸­

```js
class JavascriptParser extends Parser {
  parse(source, state) {
    // ...ç•¥

    ast = JavascriptParser.parse(source, {
      sourceType: this.sourceType,
      onComment: comments,
      onInsertedSemicolon: (pos) => semicolons.add(pos),
    });
  }
}
```

`parser.parse` æ˜¯æ ¹æ®å½“å‰çš„ sourceï¼Œä½¿ç”¨ [acorn](https://github.com/acornjs/acorn) è¿™ä¸ªè§£æå·¥å…·ï¼Œå»ç”Ÿæˆ ASTï¼Œæ ¹æ® AST æå–åˆ°è¿™ä¸ªæ¨¡å—çš„ä¾èµ–é¡¹ï¼Œç„¶åç»§ç»­é€’å½’æ‰§è¡Œæ¨¡å—çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„ä¾èµ–éƒ½å¤„ç†å®Œæˆã€‚

TODO: å…³é”®æ˜¯é€’å½’è¿™å—æ²¡æ‹æ¸…ï¼Œåœ¨å“ªé‡Œé€’å½’æ²¡æ‰¾åˆ°

### seal

æœ€ç»ˆæ•´ä¸ªä¾èµ–å¤„ç†å®Œæˆåï¼Œè¿›å…¥åˆ°æ¨¡å—çš„ seal ç¯èŠ‚ï¼Œseal æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤

- chunk ç”Ÿæˆï¼šåœ¨å‰é¢çš„æ­¥éª¤ä¸­ï¼Œå„æ¨¡å—å®ä¾‹ä¿å­˜åœ¨ compilation.modules ä¸Šï¼Œseal æ ¹æ® entry ç”Ÿæˆ chunkï¼Œç”Ÿæˆ chunk hash
- asset ç”Ÿæˆï¼šæ ¹æ® chunk ç”Ÿæˆ assetï¼Œåœ¨è¿™ä¸€æ­¥ï¼Œrequire ç­‰å¼•ç”¨è¢«è½¬æ¢ä¸ºä½¿ç”¨å†…ç½®çš„**webpack_require**å¼•ç”¨

asset å’Œ chunk çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå‡è®¾æˆ‘ä½¿ç”¨ MiniCssExtractPlugin æå–äº† cssï¼Œé‚£ä¹ˆç¼–è¯‘ç»“æœå¦‚ä¸‹

````js
        Asset      Size  Chunks             Chunk Names
app.bundle.js  4.31 KiB     app  [emitted]  app
      app.css  4.18 KiB     app  [emitted]  app
      ```
````

åœ¨ seal é˜¶æ®µç”Ÿæˆçš„ compilation.assets å¯¹è±¡ï¼Œä¸æˆ‘ä»¬æœ€ç»ˆæ‰“åŒ…å‡ºæ¥çš„ Assetï¼Œåªå·®ä¸´é—¨ä¸€è„šçš„è¾“å‡ºã€‚

### emit

compilation æ‰§è¡Œå®Œæˆä¹‹åï¼Œå†…å­˜ä¸­å·²ç»æœ‰å³å°†è¾“å‡ºçš„æ–‡ä»¶äº†ï¼Œä¿å­˜åœ¨ compilation.assetsï¼Œæå–å‡ºæ¥å†™åˆ°å¯¹åº”è¾“å‡ºæ–‡ä»¶å³å¯ã€‚

```js
assets = {
  "app.css": {
    _source: {
      children: [
        {
          _value:
            ".hello {\n  color: red;\n}\n.hello .world {\n  color: blue;\n}\n",
        },
        "\n",
      ],
    },
    // ...
  },
  "app.bundle.js": {
    // ...
  },
};
```
